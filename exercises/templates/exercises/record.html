{% extends 'main/base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0">üé§ –ó–∞–ø–∏—Å—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h3>
                </div>
                <div class="card-body">
                    <h4>{{ exercise.title }}</h4>
                    <p class="text-muted">{{ exercise.description }}</p>
                    
                    <hr>
                    
                    <!-- –¢–µ–∫—Å—Ç –¥–ª—è –æ–∑–≤—É—á–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
                    {% if exercise.text_content %}
                    <div class="mb-4">
                        <h5>–¢–µ–∫—Å—Ç –¥–ª—è –æ–∑–≤—É—á–∫–∏:</h5>
                        <div class="p-3 bg-light rounded">
                            {{ exercise.text_content|linebreaks }}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- –ê—É–¥–∏–æ-—Ä–µ–∫–æ—Ä–¥–µ—Ä -->
                    <div class="recorder-container mb-4">
                        <h5>–ê—É–¥–∏–æ-—Ä–µ–∫–æ—Ä–¥–µ—Ä:</h5>
                        
                        <div class="recorder-controls text-center mb-3">
                            <button id="recordBtn" class="btn btn-danger btn-lg">
                                <i class="fas fa-microphone"></i> –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å
                            </button>
                            <button id="stopBtn" class="btn btn-secondary btn-lg" disabled>
                                <i class="fas fa-stop"></i> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                            </button>
                            <button id="playBtn" class="btn btn-info btn-lg" disabled>
                                <i class="fas fa-play"></i> –ü—Ä–æ—Å–ª—É—à–∞—Ç—å
                            </button>
                        </div>
                        
                        <div class="text-center mb-3">
                            <div id="timer" class="display-4">00:00</div>
                            <small class="text-muted">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–∏</small>
                        </div>
                        
                        <div class="audio-preview mb-3">
                            <audio id="audioPreview" controls class="w-100"></audio>
                        </div>
                        
                        <div class="recording-status">
                            <div id="status" class="alert alert-info">
                                –ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å" —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å
                            </div>
                        </div>
                    </div>
                    
                    <!-- –§–æ—Ä–º–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                    <form method="post" enctype="multipart/form-data" id="uploadForm">
                        {% csrf_token %}
                        {{ form.audio_file }}
                        {{ form.duration }}
                        
                        <div class="d-grid gap-2">
                            <button type="submit" id="saveBtn" class="btn btn-primary btn-lg" disabled>
                                <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å
                            </button>
                            <a href="{% url 'exercises:detail' exercise.id %}" class="btn btn-outline-secondary">
                                ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Font Awesome –¥–ª—è –∏–∫–æ–Ω–æ–∫ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    .recorder-controls button {
        margin: 0 10px;
        min-width: 150px;
    }
    
    #timer {
        font-family: 'Courier New', monospace;
        color: #28a745;
        font-weight: bold;
    }
    
    audio {
        border-radius: 10px;
        background: #f8f9fa;
    }
    
    .recording {
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
// –ê—É–¥–∏–æ-—Ä–µ–∫–æ—Ä–¥–µ—Ä –Ω–∞ —á–∏—Å—Ç–æ–º JavaScript
let mediaRecorder;
let audioChunks = [];
let timerInterval;
let seconds = 0;
let audioBlob;

// –≠–ª–µ–º–µ–Ω—Ç—ã DOM
const recordBtn = document.getElementById('recordBtn');
const stopBtn = document.getElementById('stopBtn');
const playBtn = document.getElementById('playBtn');
const audioPreview = document.getElementById('audioPreview');
const timer = document.getElementById('timer');
const statusDiv = document.getElementById('status');
const saveBtn = document.getElementById('saveBtn');
const audioFileInput = document.getElementById('audioFileInput');
const durationInput = document.getElementById('durationInput');
const uploadForm = document.getElementById('uploadForm');

// –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å
recordBtn.addEventListener('click', async () => {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                sampleRate: 44100
            } 
        });
        
        mediaRecorder = new MediaRecorder(stream, {
            mimeType: 'audio/webm;codecs=opus'
        });
        
        audioChunks = [];
        
        mediaRecorder.ondataavailable = event => {
            if (event.data.size > 0) {
                audioChunks.push(event.data);
            }
        };
        
        mediaRecorder.onstop = () => {
            audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const audioUrl = URL.createObjectURL(audioBlob);
            
            audioPreview.src = audioUrl;
            playBtn.disabled = false;
            saveBtn.disabled = false;
            
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Blob –≤ File
            const audioFile = new File([audioBlob], `recording_${Date.now()}.webm`, {
                type: 'audio/webm',
                lastModified: Date.now()
            });
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(audioFile);
            audioFileInput.files = dataTransfer.files;
            durationInput.value = seconds;
            
            statusDiv.className = 'alert alert-success';
            statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> –ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ú–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å.';
            recordBtn.classList.remove('recording');
        };
        
        mediaRecorder.start();
        startTimer();
        
        recordBtn.disabled = true;
        stopBtn.disabled = false;
        
        statusDiv.className = 'alert alert-danger';
        statusDiv.innerHTML = '<i class="fas fa-circle"></i> –ò–¥–µ—Ç –∑–∞–ø–∏—Å—å...';
        recordBtn.classList.add('recording');
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
        statusDiv.className = 'alert alert-danger';
        statusDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> –û—à–∏–±–∫–∞: ${error.message}`;
    }
});

// –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å
stopBtn.addEventListener('click', () => {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        clearInterval(timerInterval);
        
        recordBtn.disabled = false;
        stopBtn.disabled = true;
    }
});

// –ü—Ä–æ—Å–ª—É—à–∞—Ç—å –∑–∞–ø–∏—Å—å
playBtn.addEventListener('click', () => {
    audioPreview.play();
});

// –¢–∞–π–º–µ—Ä
function startTimer() {
    seconds = 0;
    timer.textContent = '00:00';
    
    timerInterval = setInterval(() => {
        seconds++;
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        timer.textContent = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }, 1000);
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∑–∞–ø–∏—Å–∏
if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    statusDiv.className = 'alert alert-warning';
    statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å –∞—É–¥–∏–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome, Firefox –∏–ª–∏ Edge.';
    recordBtn.disabled = true;
}
</script>
{% endblock %}